# frozen_string_literal: true

class InstallHoardable < ActiveRecord::Migration[<%= ActiveRecord::Migration.current_version %>]
  def up
    execute(
      <<~SQL
        DO $$
        BEGIN
          IF NOT EXISTS (
            SELECT 1 FROM pg_type t WHERE t.typname = 'hoardable_operation'
          ) THEN
            CREATE TYPE hoardable_operation AS ENUM ('update', 'delete', 'insert');
          END IF;
        END
        $$;
        CREATE OR REPLACE FUNCTION hoardable_source_set_id() RETURNS trigger
          LANGUAGE plpgsql AS
        $$BEGIN
          NEW.hoardable_id = NEW.id;
          RETURN NEW;
        END;$$;
        CREATE OR REPLACE FUNCTION hoardable_version_prevent_update() RETURNS trigger
          LANGUAGE plpgsql AS
        $$BEGIN
          RAISE EXCEPTION 'updating a version is not allowed';
          RETURN NEW;
        END;$$;
      SQL
    )
  end
  def down
    execute(
      <<~SQL
        DROP TYPE IF EXISTS hoardable_operation;
        DROP FUNCTION IF EXISTS hoardable_version_prevent_update();
        DROP FUNCTION IF EXISTS hoardable_source_set_id();
      SQL
    )
  end
end
